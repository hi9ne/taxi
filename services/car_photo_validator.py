# services/car_photo_validator.py - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —á–µ—Ä–µ–∑ OpenAI Vision API
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—å, –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è

import json
import logging
from openai import OpenAI
from config import OPENAI_API_KEY

logger = logging.getLogger(__name__)

# Lazy initialization of OpenAI client with safety checks
_openai_client = None

def get_openai_client():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä OpenAI –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–∞."""
    global _openai_client
    if _openai_client is not None:
        return _openai_client
    if not OPENAI_API_KEY:
        return None
    try:
        _openai_client = OpenAI(api_key=OPENAI_API_KEY)
    except Exception as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å OpenAI –∫–ª–∏–µ–Ω—Ç: {e}")
        _openai_client = None
    return _openai_client


async def validate_and_extract_car_info(photo_file_id: str, bot) -> dict:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–æ–º–µ—Ä —á–µ—Ä–µ–∑ OpenAI Vision API.
    
    Args:
        photo_file_id: file_id —Ñ–æ—Ç–æ –∏–∑ Telegram
        bot: —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        
    Returns:
        {
            'is_valid': bool,
            'car_number': str | None,
            'message': str
        }
    """
    client = get_openai_client()
    if not client:
        logger.warning("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–æ—Ç–æ")
        return {
            'is_valid': True,
            'car_number': None,
            'message': "‚úÖ –§–æ—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ. –ù–æ–º–µ—Ä –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é."
        }
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑ Telegram
        file = await bot.get_file(photo_file_id)
        file_path = file.file_path
        photo_url = f"https://api.telegram.org/file/bot{bot.token}/{file_path}"
        
        # –ü—Ä–æ–º–ø—Ç –¥–ª—è OpenAI
        prompt = """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ —Ñ–æ—Ç–æ –∏ –æ—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
    "is_car": true/false,
    "car_number": "–Ω–æ–º–µ—Ä –µ—Å–ª–∏ –≤–∏–¥–µ–Ω —á–µ—Ç–∫–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ, –∏–Ω–∞—á–µ null"
}

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –§–û–¢–û –†–ï–ê–õ–¨–ù–û–ì–û –ê–í–¢–û–ú–û–ë–ò–õ–Ø, –∞ –Ω–µ:
   - –°–∫—Ä–∏–Ω—à–æ—Ç —Å –Ω–æ–º–µ—Ä–æ–º
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞/–Ω–æ–º–µ—Ä–∞
   - –§–æ—Ç–æ —ç–∫—Ä–∞–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞/–∫–æ–º–ø—å—é—Ç–µ—Ä–∞
   - –§–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –Ω–æ–º–µ—Ä–æ–º
   - –õ—é–±–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≥–¥–µ –Ω–æ–º–µ—Ä –Ω–∞–ø–∏—Å–∞–Ω —Ç–µ–∫—Å—Ç–æ–º, –∞ –Ω–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –Ω–æ–º–µ—Ä–Ω–æ–º –∑–Ω–∞–∫–µ

2. –ù–∞ —Ñ–æ—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω –°–ê–ú –ê–í–¢–û–ú–û–ë–ò–õ–¨ (–∫—É–∑–æ–≤, –∫–æ–ª–µ—Å–∞, –æ–∫–Ω–∞ –∏ —Ç.–¥.)

3. –ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –†–ï–ê–õ–¨–ù–û–ú –ù–û–ú–ï–†–ù–û–ú –ó–ù–ê–ö–ï –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–µ–Ω –Ω–∞ —Ñ–æ—Ç–æ

4. –ï—Å–ª–∏ —ç—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç, —Ç–µ–∫—Å—Ç, –¥–æ–∫—É–º–µ–Ω—Ç –∏–ª–∏ –Ω–æ–º–µ—Ä –≤–≤–µ–¥–µ–Ω –≤—Ä—É—á–Ω—É—é - –≤–µ—Ä–Ω–∏ "is_car": false

5. –ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–µ—Ç–∫–æ –≤–∏–¥–µ–Ω –∏ —á–∏—Ç–∞–µ–º –Ω–∞ –Ω–æ–º–µ—Ä–Ω–æ–º –∑–Ω–∞–∫–µ

6. –§–û–†–ú–ê–¢ –ö–´–†–ì–´–ó–°–ö–ò–• –ù–û–ú–ï–†–û–í –ê–í–¢–û–ú–û–ë–ò–õ–ï–ô (–°–¢–†–û–ì–û –¢–û–õ–¨–ö–û –≠–¢–ò –§–û–†–ú–ê–¢–´, –î–†–£–ì–ò–ï –ù–ï –ü–†–ò–ù–ò–ú–ê–ô):
   - "01KG123ABC" (2 —Ü–∏—Ñ—Ä—ã + "KG" + 3 —Ü–∏—Ñ—Ä—ã + 3 –±—É–∫–≤—ã)
   - "01KG123AB" (2 —Ü–∏—Ñ—Ä—ã + "KG" + 3 —Ü–∏—Ñ—Ä—ã + 2 –±—É–∫–≤—ã)
   - "1234AB" (4 —Ü–∏—Ñ—Ä—ã + 2 –±—É–∫–≤—ã)
   - "A1234B" (1 –±—É–∫–≤–∞ + 4 —Ü–∏—Ñ—Ä—ã + 1 –±—É–∫–≤–∞)
   - "AB1234" (2 –±—É–∫–≤—ã + 4 —Ü–∏—Ñ—Ä—ã)
   - "AB1234–°" (2 –±—É–∫–≤—ã + 4 —Ü–∏—Ñ—Ä—ã + 1 –±—É–∫–≤–∞)
   
   –í–ê–ñ–ù–û:
   - –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏ –æ–¥–Ω–æ–º—É –∏–∑ —ç—Ç–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ - –≤–µ—Ä–Ω–∏ null –¥–ª—è car_number
   - –ù–ï —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –Ω–æ–º–µ—Ä–∞ —Ç–∏–ø–∞ "666ZXC" (3 —Ü–∏—Ñ—Ä—ã + 3 –±—É–∫–≤—ã) - —Ç–∞–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –ù–ï–¢
   - –ù–ï —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –Ω–æ–º–µ—Ä–∞ —Ç–∏–ø–∞ "93 666 ZXC" –±–µ–∑ "KG" - —ç—Ç–æ –Ω–µ–ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä
   - –ë—É–∫–≤—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π (–ê, –í, –ï, –ö, –ú, –ù, –û, –†, –°, –¢, –£, –•) –∏–ª–∏ –ª–∞—Ç–∏–Ω–∏—Ü–µ–π
   - –ù–æ–º–µ—Ä —á–∏—Ç–∞–µ—Ç—Å—è —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
   - –ú–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ —Å–∏–º–≤–æ–ª–æ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–µ–ª—ã –∏–ª–∏ –¥–µ—Ñ–∏—Å—ã, –Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ —É–±–∏—Ä–∞–π –∏—Ö
   - –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤: "01KG123ABC", "01KG123AB", "1234AB", "A1234B", "AB1234", "AB1234–°"
   - –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏ –æ–¥–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É - –≤–µ—Ä–Ω–∏ null, –¥–∞–∂–µ –µ—Å–ª–∏ –≤–∏–¥–∏—à—å —Ü–∏—Ñ—Ä—ã –∏ –±—É–∫–≤—ã

7. –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –≤–∏–¥–µ–Ω, –Ω–µ—á–µ—Ç–∫–∏–π –∏–ª–∏ –Ω–µ—á–∏—Ç–∞–µ–º - –≤–µ—Ä–Ω–∏ null –¥–ª—è car_number, –Ω–æ "is_car": true –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å

8. –ï—Å–ª–∏ —ç—Ç–æ –ù–ï —Ñ–æ—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è - –≤–µ—Ä–Ω–∏ "is_car": false –∏ null –¥–ª—è car_number

9. –í –æ—Ç–≤–µ—Ç–µ car_number –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¢–û–õ–¨–ö–û –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, –¥–µ—Ñ–∏—Å–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
"""
        
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {"url": photo_url}
                        }
                    ]
                }
            ],
            max_tokens=150,
            response_format={"type": "json_object"}
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
        if not response.choices or not response.choices[0].message.content:
            logger.warning("OpenAI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
            return {
                'is_valid': True,
                'car_number': None,
                'message': "‚úÖ –§–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!\n‚ö†Ô∏è –ù–æ–º–µ—Ä –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é."
            }
        
        result = json.loads(response.choices[0].message.content)
        
        if not result.get("is_car", False):
            return {
                'is_valid': False,
                'car_number': None,
                'message': "‚ùå –ù–∞ —Ñ–æ—Ç–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è."
            }
        
        car_number = result.get("car_number")
        
        if car_number:
            # –û—á–∏—â–∞–µ–º –Ω–æ–º–µ—Ä –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
            car_number = car_number.upper().strip()
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã
            car_number = ''.join(c for c in car_number if c.isalnum())
        
        if car_number:
            return {
                'is_valid': True,
                'car_number': car_number,
                'message': f"‚úÖ –§–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!\nüî¢ –ù–æ–º–µ—Ä —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: {car_number}"
            }
        else:
            return {
                'is_valid': True,
                'car_number': None,
                'message': "‚úÖ –§–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!\n‚ö†Ô∏è –ù–æ–º–µ—Ä –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é."
            }
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ç–æ: {e}", exc_info=True)
        return {
            'is_valid': False,
            'car_number': None,
            'message': "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ."
        }

